-- Desync Ghost Visualizer with Ping (client-only, loadstring safe)
-- Shows where the server thinks you are, with studs distance + ping

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local Stats = game:GetService("Stats")
local player = Players.LocalPlayer
local char = player.Character or player.CharacterAdded:Wait()
local hrp = char:WaitForChild("HumanoidRootPart")

-- Clean up old ghost if any
local existing = workspace:FindFirstChild(player.Name .. "_ServerGhost")
if existing then existing:Destroy() end

-- Clone ghost
local ghost = char:Clone()
ghost.Name = player.Name .. "_ServerGhost"
ghost.Parent = workspace
for _, d in ipairs(ghost:GetDescendants()) do
	if d:IsA("Script") or d:IsA("LocalScript") then
		d:Destroy()
	elseif d:IsA("BasePart") then
		d.CanCollide = false
		d.CastShadow = false
		d.Transparency = 0.8 -- make ghost pretty transparent
	end
end
ghost.PrimaryPart = ghost:FindFirstChild("HumanoidRootPart")

-- Billboard
local billboard = Instance.new("BillboardGui")
billboard.Adornee = ghost.PrimaryPart
billboard.Size = UDim2.new(0,200,0,70)
billboard.StudsOffset = Vector3.new(0,4,0)
billboard.AlwaysOnTop = true

-- Distance text
local distText = Instance.new("TextLabel")
distText.Size = UDim2.new(1,0,0.5,0)
distText.BackgroundTransparency = 1
distText.TextColor3 = Color3.new(1,1,1)
distText.TextStrokeTransparency = 0.2
distText.TextScaled = true
distText.Font = Enum.Font.SourceSansBold
distText.Text = "..."
distText.Parent = billboard

-- Ping text (slightly transparent)
local pingText = Instance.new("TextLabel")
pingText.Position = UDim2.new(0,0,0.5,0)
pingText.Size = UDim2.new(1,0,0.5,0)
pingText.BackgroundTransparency = 1
pingText.TextColor3 = Color3.new(1,1,1)
pingText.TextTransparency = 0.25
pingText.TextStrokeTransparency = 0.4
pingText.TextScaled = true
pingText.Font = Enum.Font.SourceSans
pingText.Text = "Ping: ..."
pingText.Parent = billboard

billboard.Parent = ghost.PrimaryPart

-- Helper: get ping
local function getPing()
	local pingStat = Stats.Network.ServerStatsItem["Data Ping"]
	if pingStat then
		return math.floor(pingStat:GetValue())
	end
	return 0
end

-- Update loop
RunService.Heartbeat:Connect(function()
	if ghost and ghost.PrimaryPart then
		-- Place ghost exactly at replicated HRP (server sees this)
		ghost:SetPrimaryPartCFrame(hrp.CFrame)

		-- Stud distance
		local dist = (char.HumanoidRootPart.Position - ghost.PrimaryPart.Position).Magnitude
		distText.Text = string.format("%.1f studs", dist)

		-- Ping in ms
		pingText.Text = "Ping: " .. tostring(getPing()) .. " ms"
	end
end)
